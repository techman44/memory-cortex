services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: mcp_memory
      POSTGRES_USER: mcp
      POSTGRES_PASSWORD: ${DB_PASSWORD:-mcp_local_dev}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/01-init.sql
    ports:
      - "${DB_PORT:-41432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcp -d mcp_memory"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  embedding-service:
    build: ./embedding-service
    ports:
      - "${EMBEDDING_PORT:-41100}:8100"
    volumes:
      - model-cache:/app/models
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8100/health', timeout=3)\""]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    restart: unless-stopped

  # HTTP API server for the Web UI (always running in Docker)
  api-server:
    build: ./api-server
    ports:
      - "${API_PORT:-41200}:3100"
    environment:
      DATABASE_URL: postgresql://mcp:${DB_PASSWORD:-mcp_local_dev}@postgres:5432/mcp_memory
      EMBEDDING_URL: http://embedding-service:8100
    depends_on:
      postgres:
        condition: service_healthy
      embedding-service:
        condition: service_started
    restart: unless-stopped

  web-ui:
    build: ./web-ui
    ports:
      - "${UI_PORT:-41300}:80"
    depends_on:
      - api-server
    restart: unless-stopped

volumes:
  pgdata:
  model-cache:
